###
# colors
###
STYLE_OFF = \x1b[0m
STYLE_OK = \x1b[32;01m
STYLE_ERR = \x1b[31;01m
STYLE_WARN = \x1b[33;01m
STYLE_MUTE = \x1b[30;01m
STYLE_BRIGHT = \x1b[37;01m
STYLE_OFF = \x1b[0m
STYLE_UNDERLINE = \x1b[4m

SIGN_OK = $(STYLE_OK)  ✓$(STYLE_OFF)
SIGN_ERR = $(STYLE_ERR)  ✗$(STYLE_OFF)
SIGN_WARN = $(STYLE_WARN) !$(STYLE_OFF)


AMI_SLUG = Ubuntu

AWS_PROFILE = default
AWS_REGION = eu-central-1
ANSIBLE_ROLES_PATH= ansible.yaml
DELETE_ON_TERMINATION = true
ENCRYPT_BOOT = false
FORCE_DEREGISTER = false
INSTANCE_TYPE = m3.medium
KEEP_RELEASES = 3
ON_ERROR = ask
SHUTDOWN_BEHAVIOR = terminate
SOURCE_AMI=ami-3f1bd150
PLAYBOOK_FILE_BASE=ansible.yaml

SSH_PTY = false
SSH_TIMEOUT = 5m
SSH_USERNAME = centos


AMI_SLUG_BASE = base
AMI_DESCRIPTION_BASE=UbuntuByMilija
AMI_NAME_BASE = eiq-$(AMI_SLUG)-$(AMI_SLUG_BASE)



.PHONY: debug-packer
debug-packer:
	$(eval PACKER_DEBUG := -debug)
	@echo "$(SIGN_WARN) Enabling debug mode for Packer"

.PHONY: debug-ansible
debug-ansible:
	$(eval ANSIBLE_DEBUG := -$(ANSIBLE_VERBOSITY_LEVEL))
	@echo "$(SIGN_WARN) Enabling debug mode for Ansible"


.PHONY: force
force:
	$(eval PACKER_FORCE := -force)
	@echo "Enabling forced building mode for Packer"
	@echo "$(STYLE_WARN)WARN: this will overwrite existing artifacts.$(STYLE_OFF)"
	@echo

.PHONY: on-error
	$(eval PACKER_ONERROR := -on-error=$(ON_ERROR)) \
	@echo "Setting on-error mode to \`$(ON_ERROR)\`"



PACKER= \
	export AWS_PROFILE="$(AWS_PROFILE)" && \
	packer \
		build \
			$(PACKER_DEBUG) \
			$(PACKER_FORCE) \
			$(PACKER_ONERROR) \



.PHONY: base
base:
	@echo && \
	echo "Building \`$(AMI_SLUG_BASE)\` image" && \
	echo && \
		-var "ami_name=$(AMI_NAME_BASE)$(AMI_NAME_SUFFIX_ENCRYPTED)" \
		-var "ami_description=$(AMI_DESCRIPTION_BASE)" \
      -var "source_ami=$(SOURCE_AMI_NAME_BASE)" \
		"image.json"
